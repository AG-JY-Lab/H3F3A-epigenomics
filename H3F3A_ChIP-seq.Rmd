---
title: "Sample"
author: "Joshua Soon"
date: '2022-04-05'
output: html_document
editor_options: 
  chunk_output_type: console
---

Load essential libraries for relative pathing and yaml parsing.
```{r echo=FALSE, warning=FALSE, message=FALSE}
library(here)
library(yaml)
```


Load the config file with data paths.
```{r echo=FALSE, warning=FALSE, message=FALSE}
config <- yaml.load_file("config.yml")
print(config$Narrow_peaks_bed)
```


Load the libraries specific to this project.
```{r echo=FALSE, warning=FALSE, message=FALSE}
library(ChIPseeker)
library(clusterProfiler)
library(GenomicFeatures)
library(TxDb.Hsapiens.UCSC.hg38.knownGene)
library(ReactomePA)
library(DOSE)
```


Distribution of ChIP-seq peaks across all chromosomes.
```{r echo=False, warning=False, message=False}
narrow_peaks <- readPeakFile(config$Narrow_peaks_bed)
# Might take some time to render
covplot(narrow_peaks)
```


Load annotation database for region specific analysis of peak occupancy.
```{r echo=False, warning=False, message=False}
txdb <- TxDb.Hsapiens.UCSC.hg38.knownGene
```


Profile of ChIP peaks binding to TSS regions
First of all, for calculating the profile of ChIP peaks binding to TSS regions, we should prepare the TSS regions, which are defined as the flanking sequence of the TSS sites.
Then align the peaks that are mapping to these regions, and generate the tagMatrix.

getTagMatrix()
  windows	
    a collection of region
  
  type	
    one of "start_site", "end_site", "body"
  
  by	
    one of 'gene', 'transcript', 'exon', 'intron' , '3UTR' , '5UTR'
    
Heatmap of ChIP peaks binding to TSS regions
```{r echo=False, warning=False, message=False}
promoters <- getPromoters(TxDb=txdb, upstream=3000, downstream=3000)
tagMatrix <- getTagMatrix(narrow_peaks, windows=promoters)

peakHeatmap(narrow_peaks, TxDb=txdb, upstream=3000, downstream=3000, color="red")
```


Average Profile of ChIP peaks binding to TSS region
```{r echo=False, warning=False, message=False}
profile_plot <- plotAvgProf(tagMatrix, xlim=c(-3000, 3000),
                            xlab="Genomic Region (5'->3')",
                            ylab = "Read Count Frequency")

profile_plot
```


Confidence interval estimated by bootstrap method is also supported for characterizing ChIP binding profiles.
```{r echo=False, warning=False, message=False}
# Might take awhile due to the bootstrap sampling.
# Bootstrap sampling uses multi-core and if a job fails on one core, no results will be returned.
# This is slightly buggy on WSL2 Ubuntu but needs to be tried on bare metal.
# Works well on native Ubuntu 20.04
plotAvgProf(tagMatrix, xlim=c(-3000, 3000), conf = 0.95, resample = 1000)
```



```{r echo=False, warning=False, message=False}
plotPeakProf2(peak = narrow_peaks, upstream = rel(0.2), downstream = rel(0.2),
              conf = 0.95, by = "gene", type = "body", nbin = 800,
              TxDb = txdb, weightCol = "V7",ignore_strand = F)
```



```{r echo=False, warning=False, message=False}

```


```{r echo=False, warning=False, message=False}

```



```{r echo=False, warning=False, message=False}

```



```{r echo=False, warning=False, message=False}

```



```{r echo=False, warning=False, message=False}

```



```{r echo=False, warning=False, message=False}

```


